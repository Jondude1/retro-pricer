<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Retro Price Check</title>
<link rel="manifest" href="/static/manifest.json">
<meta name="theme-color" content="#0f0f0f">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="RetroPrice">
<link rel="apple-touch-icon" href="/static/icon-192.png">
<style>
  :root {
    --bg:     #0f0f0f;
    --card:   #1a1a1a;
    --card2:  #222;
    --border: #2a2a2a;
    --accent: #00e5a0;
    --danger: #ff4d4d;
    --warn:   #ffaa00;
    --text:   #f0f0f0;
    --muted:  #777;
    --steal:  #00e5a0;
    --good:   #4caf50;
    --fair:   #ffaa00;
    --pass:   #ff4d4d;
    --gold:   #FFD700;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
  html, body { height: 100%; }
  body { background: var(--bg); color: var(--text); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; overscroll-behavior: none; }

  /* â”€â”€ Header â”€â”€ */
  header {
    background: var(--card);
    border-bottom: 1px solid var(--border);
    padding: 10px 14px;
    display: flex; align-items: center; gap: 10px;
    position: sticky; top: 0; z-index: 200;
  }
  header h1 { font-size: 1.05rem; color: var(--accent); font-weight: 800; letter-spacing: -0.3px; flex: 1; }
  .btn-scan-header {
    background: var(--accent); color: #000; border: none;
    border-radius: 10px; padding: 9px 14px; font-size: 1.1rem;
    cursor: pointer; font-weight: 700; line-height: 1;
    flex-shrink: 0;
  }
  .btn-scan-header:active { opacity: 0.75; }

  /* â”€â”€ Search bar â”€â”€ */
  .search-bar {
    display: flex; gap: 8px; align-items: center;
    padding: 10px 14px 0;
    background: var(--card);
  }
  .search-input {
    flex: 1; background: var(--bg); border: 1.5px solid var(--border);
    border-radius: 10px; padding: 13px 14px; color: var(--text);
    font-size: 1rem; outline: none; min-width: 0;
    transition: border-color 0.15s;
  }
  .search-input:focus { border-color: var(--accent); }
  .btn-go {
    background: var(--accent); color: #000; border: none;
    border-radius: 10px; padding: 13px 18px; font-size: 1rem;
    font-weight: 800; cursor: pointer; white-space: nowrap; flex-shrink: 0;
  }
  .btn-go:active { opacity: 0.75; }

  /* â”€â”€ Console chips â”€â”€ */
  .chip-scroll {
    display: flex; gap: 7px; overflow-x: auto; padding: 10px 14px 12px;
    background: var(--card); border-bottom: 1px solid var(--border);
    scrollbar-width: none;
  }
  .chip-scroll::-webkit-scrollbar { display: none; }
  .chip {
    flex-shrink: 0; background: var(--bg); border: 1.5px solid var(--border);
    color: var(--muted); border-radius: 20px; padding: 6px 13px;
    font-size: 0.8rem; font-weight: 600; cursor: pointer;
    transition: border-color 0.15s, color 0.15s, background 0.15s;
    white-space: nowrap;
  }
  .chip.active, .chip:active {
    border-color: var(--accent); color: var(--accent); background: #0d2a1e;
  }

  /* â”€â”€ Scan panel â”€â”€ */
  #scan-panel { display: none; padding: 14px; background: #111; border-bottom: 1px solid var(--border); }
  #scan-panel h3 { font-size: 0.8rem; color: var(--accent); margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.5px; }
  #scan-preview { width: 100%; max-height: 200px; object-fit: contain; border-radius: 10px; display: none; margin-bottom: 10px; border: 1px solid var(--border); }
  .scan-status { font-size: 0.9rem; color: var(--muted); margin: 8px 0; min-height: 20px; }
  .scan-status.active { color: var(--accent); }
  .photo-request { background: #1e2a1e; border: 1px solid #2a4a2a; border-radius: 8px; padding: 10px 12px; font-size: 0.85rem; color: #90ee90; margin: 8px 0; display: none; }
  .btn-photo { width: 100%; background: var(--accent); color: #000; border: none; border-radius: 10px; padding: 14px; font-size: 1rem; font-weight: 800; cursor: pointer; margin-top: 4px; }
  .btn-photo:active { opacity: 0.75; }
  .btn-photo-2 { width: 100%; background: #1a3a2a; border: 1.5px solid var(--accent); color: var(--accent); border-radius: 10px; padding: 12px; font-size: 0.9rem; font-weight: 700; cursor: pointer; margin-top: 8px; display: none; }

  /* â”€â”€ Results â”€â”€ */
  #results { padding-bottom: 24px; }
  .result-item {
    padding: 15px 14px; border-bottom: 1px solid var(--border);
    cursor: pointer; display: flex; justify-content: space-between;
    align-items: center; gap: 12px; min-height: 64px;
    transition: background 0.1s;
  }
  .result-item:active { background: var(--card); }
  .result-left { flex: 1; min-width: 0; }
  .result-name { font-size: 0.97rem; font-weight: 700; line-height: 1.25; }
  .result-console { font-size: 0.72rem; color: var(--muted); margin-top: 3px; }
  .result-price { text-align: right; flex-shrink: 0; }
  .result-price .top-price { font-size: 1.05rem; font-weight: 800; color: var(--accent); white-space: nowrap; }
  .result-price .top-price.gold { color: var(--gold); }
  .result-price .price-label { font-size: 0.62rem; text-transform: uppercase; letter-spacing: 0.4px; color: var(--muted); margin-top: 2px; }
  .section-label { font-size: 0.68rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; padding: 14px 14px 6px; }

  /* â”€â”€ Detail â”€â”€ */
  #detail { display: none; }
  .detail-header {
    padding: 13px 14px; background: var(--card); border-bottom: 1px solid var(--border);
    display: flex; align-items: center; gap: 10px;
    position: sticky; top: 53px; z-index: 100;
  }
  .btn-back {
    background: none; border: 1.5px solid var(--border); color: var(--muted);
    border-radius: 8px; padding: 7px 12px; font-size: 0.85rem;
    cursor: pointer; white-space: nowrap; flex-shrink: 0;
  }
  .btn-back:active { background: var(--card2); }
  .detail-title-wrap { flex: 1; min-width: 0; }
  .detail-title-wrap h2 { font-size: 0.95rem; font-weight: 700; line-height: 1.2; }
  .detail-console { font-size: 0.7rem; color: var(--muted); margin-top: 2px; }

  /* â”€â”€ Condition badge â”€â”€ */
  .condition-row { padding: 12px 14px 4px; }
  .condition-badge { display: inline-block; background: #1a2a1a; border: 1px solid #3a5a3a; color: #90ee90; border-radius: 20px; padding: 5px 12px; font-size: 0.78rem; font-weight: 700; }
  .condition-grade { font-size: 0.72rem; color: var(--muted); margin-left: 6px; }
  .condition-notes { font-size: 0.78rem; color: var(--muted); margin-top: 5px; line-height: 1.4; }
  .resale-notes { font-size: 0.78rem; color: #aaa; margin-top: 8px; line-height: 1.45; }
  .resale-notes strong { color: var(--text); }

  /* â”€â”€ Price grid â”€â”€ */
  .prices-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 9px; padding: 12px 14px; }
  .price-card { background: var(--card); border: 1.5px solid var(--border); border-radius: 12px; padding: 13px; text-align: center; }
  .price-card.hi { border-color: var(--accent); }
  .price-card .p-label { font-size: 0.65rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 5px; }
  .price-card .p-val { font-size: 1.35rem; font-weight: 900; }
  .price-card.hi .p-val { color: var(--accent); }
  .price-card .p-note { font-size: 0.65rem; color: var(--muted); margin-top: 3px; }

  /* â”€â”€ DK rows â”€â”€ */
  .dko-section { padding: 0 14px 12px; display: flex; flex-direction: column; gap: 8px; }
  .dko-card {
    background: var(--card); border: 1.5px solid var(--border);
    border-radius: 12px; padding: 12px 14px;
    display: flex; justify-content: space-between; align-items: center;
  }
  .dko-card.buy { border-color: #00e5a044; background: #0a1f18; }
  .dko-label { font-size: 0.7rem; color: var(--muted); margin-bottom: 3px; }
  .dko-price { font-size: 1.15rem; font-weight: 800; }
  .dko-card.buy .dko-price { color: var(--accent); }
  .dko-link { font-size: 0.72rem; color: var(--accent); text-decoration: none; }

  /* â”€â”€ Deal calc â”€â”€ */
  .calc-section { padding: 4px 14px 16px; }
  .calc-label { font-size: 0.72rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.4px; margin-bottom: 8px; margin-top: 4px; }
  .pawn-row { display: flex; align-items: center; gap: 8px; }
  .pawn-prefix { font-size: 1.4rem; color: var(--muted); font-weight: 300; }
  .pawn-input {
    flex: 1; background: var(--bg); border: 2px solid var(--border);
    border-radius: 10px; padding: 15px 12px; color: var(--text);
    font-size: 1.5rem; font-weight: 800; outline: none;
    transition: border-color 0.15s;
  }
  .pawn-input:focus { border-color: var(--accent); }

  /* â”€â”€ Deal cards â”€â”€ */
  #deal-result { margin-top: 10px; display: flex; flex-direction: column; gap: 8px; }
  .deal-card { border-radius: 12px; padding: 14px 16px; }
  .deal-card.steal { background: #0d2a1e; border: 1.5px solid var(--steal); }
  .deal-card.good  { background: #0d1f0d; border: 1.5px solid var(--good); }
  .deal-card.fair  { background: #2a1f00; border: 1.5px solid var(--warn); }
  .deal-card.pass  { background: #2a0d0d; border: 1.5px solid var(--danger); }
  .deal-top { display: flex; justify-content: space-between; align-items: center; }
  .deal-verdict { font-size: 1.05rem; font-weight: 800; }
  .deal-cond { font-size: 0.7rem; color: var(--muted); margin-top: 2px; }
  .deal-profit-val { font-size: 1.25rem; font-weight: 900; text-align: right; }
  .deal-margin { font-size: 0.72rem; color: var(--muted); text-align: right; }

  /* â”€â”€ PC link â”€â”€ */
  .pc-link-row { padding: 4px 14px 28px; text-align: center; }
  .pc-link-row a { font-size: 0.72rem; color: var(--muted); text-decoration: none; }

  /* â”€â”€ History â”€â”€ */
  .history-item {
    padding: 13px 14px; border-bottom: 1px solid var(--border);
    cursor: pointer; display: flex; justify-content: space-between;
    align-items: center; min-height: 56px;
  }
  .history-item:active { background: var(--card); }
  .history-name { font-size: 0.92rem; font-weight: 600; }
  .history-meta { font-size: 0.7rem; color: var(--muted); margin-top: 2px; }
  .history-price { font-size: 0.9rem; color: var(--accent); font-weight: 800; }

  /* â”€â”€ Utility â”€â”€ */
  .spinner { display: inline-block; width: 17px; height: 17px; border: 2px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.7s linear infinite; vertical-align: middle; margin-right: 6px; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .loading-row { padding: 24px 16px; text-align: center; color: var(--muted); font-size: 0.9rem; }
  .hidden { display: none !important; }
</style>
</head>
<body>

<header>
  <div style="font-size:1.3rem">ğŸ•¹ï¸</div>
  <h1>Retro Price Check</h1>
  <button class="btn-scan-header" id="btn-open-scan" title="Scan with camera">ğŸ“·</button>
</header>

<!-- Search -->
<div class="search-bar">
  <input id="q" type="search" class="search-input" placeholder="Game titleâ€¦" autocomplete="off" autocorrect="off" spellcheck="false" enterkeyhint="search">
  <button class="btn-go" id="btn-search">Search</button>
</div>

<!-- Console chips -->
<div class="chip-scroll" id="chip-scroll">
  <div class="chip active" data-console="">All</div>
  {% for key, info in consoles.items() %}
  <div class="chip" data-console="{{ key }}">{{ info.name }}</div>
  {% endfor %}
</div>

<!-- Camera Scan Panel -->
<div id="scan-panel">
  <h3>ğŸ“· Scan a Game</h3>
  <img id="scan-preview" src="" alt="Preview">
  <p class="scan-status" id="scan-status">Take a photo â€” Claude will identify the game and assess condition.</p>
  <div class="photo-request" id="photo-request-box"></div>
  <input type="file" id="scan-file" accept="image/*" capture="environment" style="display:none">
  <button class="btn-photo" id="btn-take-photo">ğŸ“¸ Take Photo</button>
  <button class="btn-photo-2" id="btn-another-photo">ğŸ“¸ Take Another Photo</button>
</div>

<!-- Main area -->
<div id="main">

  <!-- Search results / history -->
  <div id="results">
    {% if history %}
    <div class="section-label">Recently Looked Up</div>
    {% for h in history %}
    <div class="history-item" onclick="loadGame('{{ h.pc_console }}','{{ h.slug }}','{{ h.game_title or "" }}','')">
      <div>
        <div class="history-name">{{ h.game_title or h.slug }}</div>
        <div class="history-meta">{{ h.pc_console }}</div>
      </div>
      {% if h.loose_price %}
      <div class="history-price">${{ "%.2f"|format(h.loose_price/100) }}</div>
      {% endif %}
    </div>
    {% endfor %}
    {% endif %}
  </div>

  <!-- Game detail -->
  <div id="detail">
    <div class="detail-header">
      <button class="btn-back" onclick="showSearch()">â† Back</button>
      <div class="detail-title-wrap">
        <h2 id="detail-title">â€”</h2>
        <div class="detail-console" id="detail-console">â€”</div>
      </div>
    </div>

    <!-- Scan condition -->
    <div id="condition-row" class="hidden condition-row">
      <span class="condition-badge" id="condition-badge"></span>
      <span class="condition-grade" id="condition-grade"></span>
      <div class="condition-notes" id="condition-notes"></div>
      <div class="resale-notes hidden" id="resale-notes-box"><strong>Resale note:</strong> <span id="resale-notes"></span></div>
    </div>

    <!-- Price cards -->
    <div class="prices-grid" id="prices-grid">
      <div class="loading-row" style="grid-column:1/-1"><span class="spinner"></span>Loading pricesâ€¦</div>
    </div>

    <!-- DK Oldies -->
    <div class="dko-section" id="dko-section" style="display:none">
      <div class="dko-card" id="dko-row" style="display:none">
        <div>
          <div class="dko-label">DK Oldies sells for</div>
          <div class="dko-price" id="dko-price">â€”</div>
        </div>
        <a class="dko-link" id="dko-link" href="#" target="_blank">View â†—</a>
      </div>
      <div class="dko-card buy" id="dko-buy-row" style="display:none">
        <div>
          <div class="dko-label">DK Oldies buys for</div>
          <div class="dko-price" id="dko-buy-price">â€”</div>
        </div>
        <div style="font-size:0.68rem;color:var(--muted);text-align:right;">from their<br>sell page</div>
      </div>
    </div>

    <!-- Deal calculator -->
    <div class="calc-section">
      <div class="calc-label">What are they asking?</div>
      <div class="pawn-row">
        <span class="pawn-prefix">$</span>
        <input type="number" id="pawn-price" class="pawn-input" placeholder="0.00" min="0" step="0.50" inputmode="decimal">
      </div>
      <div id="deal-result"></div>
    </div>

    <div class="pc-link-row">
      <a id="pc-link" href="#" target="_blank">View full price history on PriceCharting â†—</a>
    </div>
  </div>

</div><!-- /main -->

<script>
// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let currentPrices  = {};
let currentConsole = "";
let scanContext    = null;
let scanPhotoCount = 0;
const MAX_SCAN_PHOTOS = 3;

// â”€â”€ Console chip selection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.querySelectorAll(".chip").forEach(chip => {
  chip.addEventListener("click", () => {
    document.querySelectorAll(".chip").forEach(c => c.classList.remove("active"));
    chip.classList.add("active");
    currentConsole = chip.dataset.console;
  });
});

// â”€â”€ Search â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById("btn-search").addEventListener("click", doSearch);
document.getElementById("q").addEventListener("keydown", e => { if (e.key === "Enter") { e.preventDefault(); doSearch(); } });

async function doSearch() {
  const q = document.getElementById("q").value.trim();
  if (!q) return;
  hideScanPanel();
  showSearch();

  const resultsDiv = document.getElementById("results");
  resultsDiv.innerHTML = '<div class="loading-row"><span class="spinner"></span>Searchingâ€¦</div>';

  const params = new URLSearchParams({ q });
  if (currentConsole) params.append("console", currentConsole);

  try {
    const data = await fetch("/search?" + params).then(r => r.json());
    renderResults(data);
  } catch {
    resultsDiv.innerHTML = '<div class="loading-row" style="color:var(--danger)">Search failed â€” check connection</div>';
  }
}

function renderResults(results) {
  const div = document.getElementById("results");
  if (!results.length) {
    div.innerHTML = '<div class="loading-row">No results found. Try a different spelling.</div>';
    return;
  }
  div.innerHTML = results.map(r => {
    const loose = r.loose_cents  || 0;
    const dkBuy = r.dk_buy_cents || 0;
    const isGold = dkBuy > 0 && loose > 0 && dkBuy > loose;
    const priceHtml = dkBuy
      ? `<div class="top-price${isGold ? " gold" : ""}">$${cents(dkBuy)}</div><div class="price-label">DK pays</div>`
      : loose
        ? `<div class="top-price">$${cents(loose)}</div><div class="price-label">loose</div>`
        : "";
    return `<div class="result-item" onclick="loadGame('${esc(r.pc_console)}','${esc(r.slug)}','${esc(r.name)}','${esc(currentConsole)}')">
      <div class="result-left">
        <div class="result-name">${esc(r.name)}</div>
        <div class="result-console">${esc(r.console_name)}</div>
      </div>
      <div class="result-price">${priceHtml}</div>
    </div>`;
  }).join("");
}

// â”€â”€ Game detail â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadGame(pc_console, slug, name, console_key, scanResult) {
  showDetail();
  document.getElementById("detail-title").textContent  = name || slug.replace(/-/g, " ");
  document.getElementById("detail-console").textContent = pc_console.replace(/-/g, " ");
  document.getElementById("prices-grid").innerHTML      = '<div class="loading-row" style="grid-column:1/-1"><span class="spinner"></span>Loading pricesâ€¦</div>';
  document.getElementById("dko-section").style.display  = "none";
  document.getElementById("dko-row").style.display      = "none";
  document.getElementById("dko-buy-row").style.display  = "none";
  document.getElementById("deal-result").innerHTML      = "";
  document.getElementById("pawn-price").value           = "";
  document.getElementById("condition-row").classList.add("hidden");

  if (scanResult && scanResult.identified) showCondition(scanResult);

  try {
    const params = new URLSearchParams({ pc_console, slug, name, console_key });
    const data   = await fetch("/prices?" + params).then(r => r.json());
    renderPrices(data, pc_console);
  } catch {
    document.getElementById("prices-grid").innerHTML = '<div class="loading-row" style="color:var(--danger)">Failed to load prices</div>';
  }
}

function showCondition(s) {
  const condMap = { loose:"Loose (Cart Only)", cib:"Complete in Box", cib_incomplete:"Incomplete CIB", new_sealed:"New/Sealed", damaged:"Damaged", unknown:"Condition Unknown" };
  document.getElementById("condition-badge").textContent = condMap[s.condition] || s.condition;
  document.getElementById("condition-grade").textContent = s.condition_grade ? `Â· ${s.condition_grade}` : "";
  document.getElementById("condition-notes").textContent = s.condition_notes || "";
  document.getElementById("resale-notes").textContent    = s.resale_notes || "";
  document.getElementById("resale-notes-box").classList.toggle("hidden", !s.resale_notes);
  document.getElementById("condition-row").classList.remove("hidden");
}

function renderPrices(data, pc_console) {
  const prices = data.prices || {};
  currentPrices = prices;

  document.getElementById("detail-title").textContent   = data.title || document.getElementById("detail-title").textContent;
  document.getElementById("detail-console").textContent = pc_console.replace(/-/g, " ");
  if (data.pc_url) document.getElementById("pc-link").href = data.pc_url;

  const cards = [["loose","Loose",true],["cib","CIB",false],["new","New/Sealed",false],["graded","Graded",false]].filter(([k]) => prices[k]);

  if (!cards.length) {
    document.getElementById("prices-grid").innerHTML = '<div class="loading-row" style="grid-column:1/-1">No price data found</div>';
  } else {
    document.getElementById("prices-grid").innerHTML = cards.map(([k, label, hi]) =>
      `<div class="price-card${hi ? " hi" : ""}">
        <div class="p-label">${label}</div>
        <div class="p-val">$${cents(prices[k])}</div>
        <div class="p-note">market avg</div>
      </div>`
    ).join("");
  }

  // DK Oldies
  let showSection = false;
  if (data.dk_price) {
    document.getElementById("dko-price").textContent = "$" + cents(data.dk_price);
    document.getElementById("dko-row").style.display = "";
    if (data.dk_url) document.getElementById("dko-link").href = data.dk_url.startsWith("http") ? data.dk_url : "https://www.dkoldies.com" + data.dk_url;
    showSection = true;
  }
  if (data.dk_buy_price) {
    document.getElementById("dko-buy-price").textContent  = "$" + cents(data.dk_buy_price);
    document.getElementById("dko-buy-row").style.display  = "";
    showSection = true;
  }
  if (showSection) document.getElementById("dko-section").style.display = "";

  // Auto-focus pawn input
  setTimeout(() => document.getElementById("pawn-price").focus(), 350);

  const pawnVal = document.getElementById("pawn-price").value;
  if (pawnVal) updateDeal(parseFloat(pawnVal));
}

// â”€â”€ Deal calculator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById("pawn-price").addEventListener("input", e => {
  const v = parseFloat(e.target.value);
  if (!isNaN(v) && v > 0) updateDeal(v);
  else document.getElementById("deal-result").innerHTML = "";
});

async function updateDeal(dollars) {
  const pawnCents = Math.round(dollars * 100);
  const params = new URLSearchParams({ pawn: pawnCents });
  if (currentPrices.loose) params.append("loose", currentPrices.loose);
  if (currentPrices.cib)   params.append("cib",   currentPrices.cib);
  if (currentPrices.new)   params.append("new",   currentPrices.new);

  try {
    const data = await fetch("/deal?" + params).then(r => r.json());
    const condOrder = [["loose","Selling loose"],["cib","Selling CIB"],["new","Selling new/sealed"]];
    document.getElementById("deal-result").innerHTML = condOrder
      .filter(([k]) => data[k])
      .map(([k, sublabel]) => {
        const d = data[k];
        return `<div class="deal-card ${d.tag}">
          <div class="deal-top">
            <div>
              <div class="deal-verdict">${d.emoji} ${d.label}</div>
              <div class="deal-cond">${sublabel}</div>
            </div>
            <div>
              <div class="deal-profit-val" style="color:${d.profit >= 0 ? "var(--steal)" : "var(--danger)"}">
                ${d.profit >= 0 ? "+" : ""}$${cents(d.profit)}
              </div>
              <div class="deal-margin">${d.margin_pct}% margin</div>
            </div>
          </div>
        </div>`;
      }).join("") || "";
  } catch { /* ignore */ }
}

// â”€â”€ Camera Scan â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById("btn-open-scan").addEventListener("click", () => {
  const p = document.getElementById("scan-panel");
  const showing = p.style.display === "block";
  p.style.display = showing ? "none" : "block";
  if (!showing) { scanContext = null; scanPhotoCount = 0; }
});
document.getElementById("btn-take-photo").addEventListener("click",    () => document.getElementById("scan-file").click());
document.getElementById("btn-another-photo").addEventListener("click", () => document.getElementById("scan-file").click());

document.getElementById("scan-file").addEventListener("change", async e => {
  const file = e.target.files[0];
  if (!file) return;

  const preview  = document.getElementById("scan-preview");
  preview.src    = URL.createObjectURL(file);
  preview.style.display = "block";

  const status   = document.getElementById("scan-status");
  const photoReq = document.getElementById("photo-request-box");
  const btn2     = document.getElementById("btn-another-photo");

  status.className = "scan-status active";
  status.innerHTML = '<span class="spinner"></span>Analyzing with Claudeâ€¦';
  photoReq.style.display = "none";
  btn2.style.display = "none";

  const fd = new FormData();
  fd.append("image", file);
  let endpoint = "/scan";
  if (scanContext && scanPhotoCount > 0) {
    endpoint = "/scan/followup";
    fd.append("context", JSON.stringify(scanContext));
  }

  try {
    const data = await fetch(endpoint, { method: "POST", body: fd }).then(r => r.json());
    if (data.error) { status.className = "scan-status"; status.textContent = "Error: " + data.error; return; }

    scanContext = data;
    scanPhotoCount++;

    if (!data.identified) {
      status.className = "scan-status";
      status.textContent = "Couldn't identify the game. Try a clearer photo.";
      btn2.style.display = "block";
      return;
    }
    if (data.needs_more_photos && scanPhotoCount < MAX_SCAN_PHOTOS) {
      status.className = "scan-status";
      status.textContent = `Identified: ${data.game_name} (${data.console_display || ""})`;
      photoReq.textContent = "ğŸ“¸ " + data.photo_request;
      photoReq.style.display = "block";
      btn2.style.display = "block";
      btn2.textContent = "ğŸ“¸ Take Another Photo";
      return;
    }

    status.className = "scan-status";
    status.textContent = `Found: ${data.game_name} Â· ${data.condition_grade || ""} ${conditionLabel(data.condition)}`;
    photoReq.style.display = "none";
    btn2.style.display = "none";

    document.getElementById("q").value = data.game_name;
    if (data.console_key) {
      currentConsole = data.console_key;
      document.querySelectorAll(".chip").forEach(c => {
        c.classList.toggle("active", c.dataset.console === data.console_key);
      });
    }

    const params = new URLSearchParams({ q: data.game_name });
    if (data.console_key) params.append("console", data.console_key);
    const results = await fetch("/search?" + params).then(r => r.json());

    if (results.length > 0) {
      hideScanPanel();
      loadGame(results[0].pc_console, results[0].slug, results[0].name, data.console_key || "", data);
    } else {
      hideScanPanel(); showSearch(); renderResults(results);
    }
  } catch (err) {
    status.className = "scan-status"; status.textContent = "Scan failed: " + err.message;
  }
  e.target.value = "";
});

// â”€â”€ Navigation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showDetail() {
  document.getElementById("results").style.display = "none";
  document.getElementById("detail").style.display  = "block";
  window.scrollTo(0, 0);
}
function showSearch() {
  document.getElementById("results").style.display = "block";
  document.getElementById("detail").style.display  = "none";
}
function hideScanPanel() { document.getElementById("scan-panel").style.display = "none"; }

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function cents(c) {
  if (c == null) return "â€”";
  const abs = Math.abs(c);
  return (c < 0 ? "-" : "") + (abs / 100).toFixed(2);
}
function esc(s) { return (s || "").replace(/'/g, "\\'").replace(/"/g, "&quot;"); }
function conditionLabel(c) {
  return { loose:"Loose", cib:"Complete in Box", cib_incomplete:"Incomplete CIB", new_sealed:"New/Sealed", damaged:"Damaged", unknown:"" }[c] || c || "";
}

// â”€â”€ Service Worker â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => navigator.serviceWorker.register("/static/sw.js").catch(() => {}));
}
</script>
</body>
</html>
